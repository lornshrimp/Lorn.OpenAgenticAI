# Director调度引擎接口设计

## 概述

本文档详细描述了Director调度引擎对外提供的接口设计，包括与用户界面、大语言模型、Agent调度中心、工作流管理器和知识库的交互接口。作为系统的中枢神经，Director调度引擎需要通过这些接口协调各组件的工作，确保任务能够被正确理解、规划和执行。

## 接口分类

Director调度引擎的接口可分为以下几类：

1. **用户界面接口** - 接收用户请求，返回执行结果和状态
2. **LLM交互接口** - 与大语言模型进行意图解析和任务规划
3. **Agent调度接口** - 与AgentHub交互，调度和监控Agent执行
4. **工作流接口** - 与工作流管理器交互，加载和执行工作流
5. **知识库接口** - 与知识库交互，获取和存储上下文信息
6. **内部组件接口** - Director内部各模块之间的接口

> **注意**: 本文档中的接口定义采用与编程语言无关的概念描述，实际实现可根据技术栈选择适当的编程语言和框架。所有接口使用的数据对象在 [CoreBusinessObjects.md](../CoreBusinessObjects.md) 和 [BusinessObjects.md](BusinessObjects.md) 中已详细定义。

## 接口详细设计

### 1. 用户界面接口

#### 1.1 接收用户请求

**功能**: 接收用户的自然语言请求，开始处理流程  
**输入参数**:
- userRequest: 用户的自然语言请求内容
- userId: 用户标识
- sessionId: 会话标识，用于关联上下文  
**返回值**: 任务标识，用于后续查询任务状态  
**异步操作**: 是

#### 1.2 获取任务状态

**功能**: 获取指定任务的当前执行状态  
**输入参数**:
- taskId: 任务标识  
**返回值**: TaskStatusInfo对象，包括进度、当前步骤等  
**异步操作**: 是

#### 1.3 获取任务结果

**功能**: 获取已完成任务的执行结果  
**输入参数**:
- taskId: 任务标识  
**返回值**: TaskResult对象，包括成功/失败状态、输出内容等  
**异步操作**: 是

#### 1.4 控制任务执行

**功能**: 控制任务的执行流程，如暂停、继续、取消等  
**输入参数**:
- taskId: 任务标识
- action: 控制动作（暂停/继续/取消）  
**返回值**: 布尔值，表示操作是否成功  
**异步操作**: 是

### 2. LLM交互接口

#### 2.1 意图解析请求

**功能**: 向LLM发送意图解析请求  
**输入参数**:
- userRequest: 用户原始请求
- contextInfo: ContextInfo对象，包含相关上下文信息  
**返回值**: IntentInfo对象，包含解析后的意图信息  
**异步操作**: 是

#### 2.2 任务规划请求

**功能**: 向LLM请求任务规划  
**输入参数**:
- intentInfo: IntentInfo对象，包含解析后的意图信息
- availableCapabilities: AgentCapability对象列表，表示系统当前可用的Agent能力
- contextInfo: ContextInfo对象，包含相关上下文信息  
**返回值**: ExecutionPlan对象，包含任务执行计划  
**异步操作**: 是

#### 2.3 执行调整请求

**功能**: 根据执行反馈，请求LLM调整执行计划  
**输入参数**:
- currentPlan: ExecutionPlan对象，表示当前执行计划
- executionFeedback: ExecutionFeedback对象，包含执行过程中的反馈信息
- contextInfo: ContextInfo对象，包含相关上下文信息  
**返回值**: ExecutionPlan对象，包含调整后的执行计划  
**异步操作**: 是

### 3. Agent调度接口

#### 3.1 Agent能力查询

**功能**: 查询当前系统中可用的Agent能力  
**输入参数**: 无  
**返回值**: AgentCapability对象列表，表示可用的Agent能力  
**异步操作**: 是

#### 3.2 Agent调度请求

**功能**: 请求AgentHub调度Agent执行任务  
**输入参数**:
- stepId: 执行步骤标识
- requiredCapability: AgentCapability对象，表示所需Agent能力
- parameters: 键值对集合，表示执行参数  
**返回值**: StepExecutionResult对象，包含执行结果  
**异步操作**: 是

#### 3.3 Agent执行状态查询

**功能**: 查询Agent执行状态  
**输入参数**:
- stepId: 执行步骤标识  
**返回值**: StepStatus枚举值，表示步骤执行状态  
**异步操作**: 是

#### 3.4 Agent执行控制

**功能**: 控制Agent执行，如暂停、继续、取消等  
**输入参数**:
- stepId: 执行步骤标识
- action: AgentControlAction枚举值，表示控制动作  
**返回值**: 布尔值，表示操作是否成功  
**异步操作**: 是

### 4. 工作流接口

#### 4.1 加载工作流定义

**功能**: 从工作流管理器加载工作流定义  
**输入参数**:
- workflowId: 工作流标识  
**返回值**: WorkflowDefinition对象，包含工作流定义  
**异步操作**: 是

#### 4.2 执行工作流

**功能**: 执行指定的工作流  
**输入参数**:
- workflowId: 工作流标识
- parameters: 键值对集合，表示工作流参数
- userId: 用户标识  
**返回值**: 工作流执行标识字符串  
**异步操作**: 是

#### 4.3 更新工作流执行状态

**功能**: 更新工作流执行状态  
**输入参数**:
- executionId: 工作流执行标识
- status: ExecutionStatus枚举值，表示最新状态
- executionResults: 键值对集合，表示执行结果（如果有）  
**返回值**: 布尔值，表示操作是否成功  
**异步操作**: 是

### 5. 知识库接口

#### 5.1 获取上下文信息

**功能**: 从知识库获取相关上下文信息  
**输入参数**:
- userId: 用户标识
- taskId: 任务标识
- contextType: ContextType枚举值，表示上下文类型  
**返回值**: ContextInfo对象，包含上下文信息  
**异步操作**: 是

#### 5.2 存储执行记录

**功能**: 将执行记录存入知识库  
**输入参数**:
- taskId: 任务标识
- executionRecord: ExecutionRecord对象，包含执行记录  
**返回值**: 布尔值，表示操作是否成功  
**异步操作**: 是

#### 5.3 更新用户偏好

**功能**: 更新用户偏好信息  
**输入参数**:
- userId: 用户标识
- preferences: 键值对集合，表示偏好信息  
**返回值**: 布尔值，表示操作是否成功  
**异步操作**: 是

### 6. 内部组件接口

#### 6.1 意图解析器接口

**功能**: 解析用户意图  
**输入参数**:
- request: 用户请求字符串
- context: ContextInfo对象，包含上下文信息  
**返回值**: IntentInfo对象，包含解析后的意图  
**异步操作**: 是

#### 6.2 任务规划器接口

**功能**: 创建任务执行计划  
**输入参数**:
- intent: IntentInfo对象，包含解析后的意图
- availableCapabilities: AgentCapability对象列表，表示可用能力
- context: ContextInfo对象，包含上下文信息  
**返回值**: ExecutionPlan对象，包含执行计划  
**异步操作**: 是

#### 6.3 执行协调器接口

**功能**: 执行计划  
**输入参数**:
- plan: ExecutionPlan对象，包含执行计划
- taskId: 任务标识  
**返回值**: ExecutionResult对象，包含执行结果  
**异步操作**: 是

**功能**: 监控执行状态  
**输入参数**:
- taskId: 任务标识  
**返回值**: ExecutionStatus枚举值，表示当前执行状态  
**异步操作**: 是

#### 6.4 上下文管理器接口

**功能**: 创建执行上下文  
**输入参数**:
- taskId: 任务标识
- initialContext: ContextInfo对象，包含初始上下文  
**返回值**: 上下文标识字符串  
**异步操作**: 是

**功能**: 更新执行上下文  
**输入参数**:
- contextId: 上下文标识
- updates: 键值对集合，表示更新内容  
**返回值**: 布尔值，表示操作是否成功  
**异步操作**: 是

#### 6.5 错误处理器接口

**功能**: 处理执行错误  
**输入参数**:
- error: ErrorInfo对象，包含错误信息
- taskId: 任务标识
- stepId: 步骤标识  
**返回值**: ErrorHandlingStrategy枚举值，表示错误处理策略  
**异步操作**: 是

## 错误处理机制

### 错误分类

1. **意图解析错误** - 无法理解用户意图或提取必要参数
2. **规划错误** - 无法创建有效的执行计划
3. **执行错误** - Agent执行过程中发生错误
4. **资源错误** - 所需资源不可用
5. **权限错误** - 无足够权限执行操作
6. **超时错误** - 操作执行超时

### 错误处理策略

错误处理采用ErrorHandlingStrategy枚举中定义的策略：
- **Retry** - 重试操作
- **UseAlternative** - 使用替代方案
- **AskForClarification** - 向用户请求澄清
- **SkipStep** - 跳过当前步骤
- **AbortTask** - 中止整个任务

## 安全性设计

### 接口安全控制

1. **认证验证** - 确保调用方有权限访问接口
2. **参数验证** - 验证所有输入参数的合法性
3. **数据脱敏** - 敏感信息在传输和记录时进行脱敏
4. **访问限流** - 防止过度频繁的接口调用
5. **操作审计** - 记录所有关键操作，便于追溯

### 权限控制

**权限检查接口**:  
**功能**: 检查用户是否拥有特定权限  
**输入参数**:
- userId: 用户标识
- requiredPermission: 所需权限名称  
**返回值**: 布尔值，表示是否拥有权限  
**异步操作**: 是

**操作审计接口**:  
**功能**: 记录审计信息  
**输入参数**:
- userId: 用户标识
- operation: 操作名称
- targetResource: 目标资源
- isSuccessful: 是否成功
- details: 详细信息  
**返回值**: 无  
**异步操作**: 是

## 接口版本控制

为确保系统可以平滑升级，所有接口都应包含版本信息，并保持向后兼容。建议采用以下版本控制机制：

1. **URI路径版本** - 在API路径中包含版本号
2. **请求头版本** - 在请求头中指定API版本
3. **参数版本** - 在请求参数中指定版本

示例接口版本控制：
```
接口: ProcessUserRequest
版本1.0: 基本处理功能，支持文本输入
版本1.1: 增加用户偏好参数，支持更精确的意图识别
版本2.0: 增加多模态输入支持，可处理图像和语音
```

## 健康监控与度量

### 监控指标

1. **请求处理时间** - 各类请求的处理耗时
2. **错误率** - 按错误类型统计的错误发生率
3. **并发任务数** - 系统当前处理的任务数量
4. **资源利用率** - CPU、内存等资源使用情况
5. **调用频率** - 各接口被调用的频率

### 健康检查接口

**功能**: 系统健康状态检查  
**输入参数**: 无  
**返回值**: HealthStatus对象，包含健康状态信息  
**异步操作**: 是

## 接口测试建议

1. **单元测试** - 测试各接口的基本功能和边界条件
2. **集成测试** - 测试与其他组件的交互
3. **负载测试** - 测试在高负载下的性能和稳定性
4. **故障注入测试** - 模拟各种错误情况，测试错误处理能力
5. **安全性测试** - 测试接口的安全防护能力

## 接口演进路线图

### 短期计划

1. 完善基础接口功能实现
2. 添加全面的错误处理机制
3. 实现接口监控和日志记录

### 中期计划

1. 支持批量任务处理
2. 增强上下文管理能力
3. 添加任务优先级和资源调度功能

### 长期计划

1. 支持分布式部署和负载均衡
2. 实现跨设备任务协同
3. 添加自适应优化机制，根据历史执行数据优化计划生成